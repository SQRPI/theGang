<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>纸牌帮</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #0b1220;
        --muted: #6b7280;
        --border: #e6e8f0;
        --shadow: 0 10px 30px rgba(10, 15, 40, .10);
        --radius: 14px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
        background: var(--bg);
        color: var(--text);
        -webkit-tap-highlight-color: transparent;
      }
      /* 大屏时放宽主体宽度，让一行能容纳更多玩家卡片 */
      .app { max-width: 1800px; margin: 0 auto; padding: 12px; }
      .topbar {
        position: sticky; top: 0; z-index: 5;
        background: rgba(246,247,251,.86);
        backdrop-filter: blur(10px);
        padding: 10px 0;
      }
      .topbarRow { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .title { font-weight: 900; letter-spacing: .2px; }
      .pill { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: #fbfbff; font-size: 12px; }
      .pill.ok { border-color:#99f6e4; background:#ecfeff; color:#0f766e; }
      .pill.warn { border-color:#fde68a; background:#fffbeb; color:#92400e; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .muted { color: var(--muted); font-size: 12px; }

      .layout { display:grid; grid-template-columns: 1fr; gap: 12px; }
      @media (min-width: 980px) {
        .layout { grid-template-columns: 360px 1fr; align-items:start; }
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 12px;
      }
      .panelTitle { font-size: 13px; font-weight: 800; margin: 0 0 10px; color:#1f2937; }

      .row { display:flex; gap: 10px; align-items:center; }
      .col { display:flex; flex-direction:column; gap:10px; }
      .grow { flex: 1; }

      input, select, button {
        height: 44px;
        border-radius: 12px;
        border: 1px solid #d7d9e3;
        padding: 0 12px;
        background: #fff;
        font-size: 14px;
      }
      button { cursor:pointer; background:#111827; color:#fff; border-color:#111827; font-weight: 800; }
      button.secondary { background:#fff; color:#111827; }
      button.ghost { background: transparent; color:#111827; border-color: var(--border); }
      button:disabled { opacity:.5; cursor:not-allowed; }
      .btnRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
      @media (min-width: 520px) {
        .btnRow { grid-template-columns: repeat(4, 1fr); }
      }

      .tableGrid { display:grid; grid-template-columns: 1fr; gap: 12px; }
      @media (min-width: 720px) {
        .tableGrid { grid-template-columns: 1.2fr 1fr; }
      }

      .cards { display:flex; gap: 10px; flex-wrap: wrap; }
      .playingCard {
        width: 52px; height: 74px;
        border-radius: 14px;
        border: 1px solid #d7d9e3;
        background: linear-gradient(180deg, #ffffff, #fbfbff);
        box-shadow: 0 10px 25px rgba(10, 15, 40, .10);
        padding: 8px;
        display:flex; flex-direction:column; justify-content:space-between;
      }
      .playingCard .r { font-weight: 900; font-size: 16px; }
      .playingCard .s { font-size: 16px; }
      .playingCard.red { color: #b91c1c; }
      .playingCard.black { color: #111827; }
      .playingCard .corner { display:flex; gap: 6px; align-items:center; }
      .playingCard .big { font-size: 28px; line-height: 1; text-align:center; opacity: .9; }

      .chipCircle {
        width: 48px; height: 48px; border-radius: 999px;
        display:flex; align-items:center; justify-content:center;
        border: 2px solid #cfd3e3;
        background: radial-gradient(circle at 30% 30%, #ffffff, #eef1ff);
        box-shadow: 0 8px 18px rgba(10, 15, 40, .10);
        font-weight: 900;
        user-select:none;
        position: relative;
      }
      .chipCircle.small { width: 32px; height: 32px; font-size: 12px; box-shadow:none; font-weight: 900; }
      .chipCircle.r1 { border-color: #fb7185; background: radial-gradient(circle at 30% 30%, #ffffff, #ffe4e6); }
      .chipCircle.r2 { border-color: #60a5fa; background: radial-gradient(circle at 30% 30%, #ffffff, #dbeafe); }
      .chipCircle.r3 { border-color: #34d399; background: radial-gradient(circle at 30% 30%, #ffffff, #d1fae5); }
      .chipCircle.r4 { border-color: #a78bfa; background: radial-gradient(circle at 30% 30%, #ffffff, #ede9fe); }
      .chipCircle.clickable { cursor:pointer; border-color:#111827; }
      .chipCircle.clickable:active { transform: translateY(1px); }
      .chipCircle.marked { border-color:#f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,.25), 0 8px 18px rgba(10, 15, 40, .10); }
      .chipCircle.marked::after {
        content:"";
        position:absolute;
        top: 7px; right: 7px;
        width: 8px; height: 8px;
        border-radius: 999px;
        background:#f59e0b;
        box-shadow: 0 0 0 2px rgba(255,255,255,.95);
      }
      .chipGrid { display:flex; flex-wrap:wrap; gap: 10px; }

      .playersGrid {
        display:grid;
        /* 跟随可用宽度自动增减列数：大屏更多列，小屏更大触控区 */
        grid-template-columns: repeat(auto-fit, minmax(clamp(150px, 15vw, 240px), 1fr));
        gap: 10px;
      }
      .playerCard {
        border:1px solid #eceef6;
        border-radius: 14px;
        padding: 10px;
        background:#fcfdff;
        display:flex;
        flex-direction:column;
        gap: 8px;
      }
      .playerTop { display:flex; justify-content:space-between; gap: 10px; align-items:flex-start; }
      .playerName { font-weight: 900; font-size: 14px; line-height: 1.2; }
      .tags { display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
      .chipLine { display:flex; justify-content:space-between; align-items:center; gap: 10px; }
      .chipHistory { display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
      .divider { height:1px; background: #eef0f7; margin: 6px 0; }

      .logBox {
        background:#0b1020;
        color:#d6e0ff;
        border-radius: 14px;
        padding: 10px;
        max-height: 260px;
        overflow:auto;
      }
      .logItem { font-size: 12px; line-height: 1.55; opacity:.96; }
      .logItem.muted { color:#9aa6c9; }

      .sheetBackdrop {
        position: fixed; inset: 0; z-index: 20;
        background: rgba(10, 15, 40, .45);
        display:none;
      }
      .sheetBackdrop.show { display:block; }
      .sheet {
        position: fixed; left: 0; right: 0; bottom: 0; z-index: 21;
        background: #fff;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
        box-shadow: 0 -10px 30px rgba(10,15,40,.25);
        transform: translateY(105%);
        transition: transform .18s ease;
        padding: 12px;
        max-height: 75vh;
        overflow:auto;
      }
      .sheet.show { transform: translateY(0); }
      .sheetHead { display:flex; justify-content:space-between; align-items:center; gap:10px; }
      .sheetTitle { font-weight: 900; }
      .sheetList { margin-top: 10px; display:flex; flex-direction:column; gap: 8px; }
      .sheetRow { border:1px solid var(--border); background:#fbfbff; border-radius: 12px; padding: 10px; font-size: 13px; }

      .modalBackdrop {
        position: fixed; inset: 0; z-index: 30;
        background: rgba(10, 15, 40, .55);
        display:none;
      }
      .modalBackdrop.show { display:block; }
      .modal {
        position: fixed; left: 12px; right: 12px; top: 10vh; z-index: 31;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 20px 60px rgba(10,15,40,.35);
        padding: 12px;
        max-height: 80vh;
        overflow:auto;
        display:none;
      }
      .modal.show { display:block; }
      .rankRow { border:1px solid var(--border); border-radius: 14px; padding: 10px; background:#fcfdff; margin-top: 10px; }
      .rankRow:first-child { margin-top: 0; }
      .rankTop { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
      .rankName { font-weight: 900; }
      .rankSub { margin-top: 6px; font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="topbarRow">
          <div class="title">纸牌帮</div>
          <div class="row" style="gap:8px;">
            <div class="pill">阶段：<span id="stage">-</span></div>
            <div class="pill">轮次：<span id="round">-</span></div>
          </div>
        </div>
        <div class="topbarRow" style="margin-top:8px;">
          <div class="muted">房间：<span class="mono" id="ridShow">-</span></div>
          <div class="muted">你：<span class="mono" id="pid">-</span></div>
        </div>
      </div>

      <div class="layout">
        <div class="panel">
          <div class="panelTitle">连接与房间</div>
          <div class="col">
            <input id="nickname" placeholder="昵称（必填）" maxlength="20" />
            <div class="row">
              <input id="rid" class="mono grow" placeholder="房间号" />
              <button id="btnCreate" style="min-width:110px;">创建</button>
            </div>
            <div class="row" style="justify-content:space-between;">
              <label class="pill" style="gap:8px; user-select:none;">
                <input id="spectate" type="checkbox" style="height:auto; width:auto; margin:0;" />
                观战加入
              </label>
              <div class="muted" id="joinHint">加入后可观战/待加入</div>
            </div>

            <div class="btnRow">
              <button id="btnJoin" class="secondary">加入</button>
              <button id="btnStart" disabled>开始</button>
              <button id="btnNewGame" disabled>下一局</button>
              <button id="btnLeave" class="ghost" disabled>退出</button>
            </div>

            <div class="divider"></div>
            <div class="panelTitle" style="margin:0;">房主设置</div>
            <div class="muted">未开始/亮牌后可改</div>
            <div class="row">
              <select id="holeCount" class="grow">
                <option value="2">手牌 2 张</option>
                <option value="3">手牌 3 张</option>
                <option value="4">手牌 4 张</option>
                <option value="5">手牌 5 张</option>
                <option value="6">手牌 6 张</option>
              </select>
              <select id="rule" class="grow">
                <option value="holdem">德州</option>
                <option value="omaha">奥马哈</option>
              </select>
            </div>
            <label class="pill" style="gap:8px; user-select:none; justify-content:flex-start;">
              <input id="fastPick" type="checkbox" style="height:auto; width:auto; margin:0;" />
              实时筹码（不按顺序拿）
            </label>
            <button id="btnSetOpt" class="secondary" disabled>应用设置</button>

            <div class="divider"></div>
            <div class="pill warn" id="turnHint">未开始</div>
            <div class="muted">提示：点筹码可查看该轮筹码流转。</div>
          </div>
        </div>

        <div class="panel">
          <div class="panelTitle">牌桌</div>
          <div class="tableGrid">
            <div>
              <div class="muted">公共牌</div>
              <div class="cards" id="board"></div>
              <div style="height:10px;"></div>
              <div class="muted">公共筹码（点击拿取；也可点查看流转）</div>
              <div class="chipGrid" id="publicChips"></div>
            </div>
            <div>
              <div class="muted">日志（当前局）</div>
              <div class="logBox" id="log"></div>
              <div style="height:10px;"></div>
              <details id="historyDetails">
                <summary class="muted" style="cursor:pointer;">对局历史（最近 50 局）</summary>
                <div style="height:8px;"></div>
                <div id="history" class="col"></div>
              </details>
            </div>
          </div>

          <div style="height:12px;"></div>
          <div class="panelTitle" style="margin:0 0 10px;">玩家</div>
          <div class="playersGrid" id="players"></div>
        </div>
      </div>
    </div>

    <div id="sheetBackdrop" class="sheetBackdrop"></div>
    <div id="sheet" class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="sheetTitle" id="sheetTitle">-</div>
        <button id="btnCloseSheet" class="ghost" style="height:40px;">关闭</button>
      </div>
      <div class="sheetList" id="sheetList"></div>
    </div>

    <div id="modalBackdrop" class="modalBackdrop"></div>
    <div id="showdownModal" class="modal" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="sheetTitle">结算（按筹码从小到大）</div>
        <button id="btnCloseModal" class="ghost" style="height:40px;">关闭</button>
      </div>
      <div class="muted" id="showdownSub" style="margin-top:6px;"></div>
      <div id="showdownList" style="margin-top:10px;"></div>
    </div>

    <script>
      const logEl = document.getElementById("log");
      const historyEl = document.getElementById("history");
      const historyDetailsEl = document.getElementById("historyDetails");

      const pidEl = document.getElementById("pid");
      const ridEl = document.getElementById("rid");
      const ridShowEl = document.getElementById("ridShow");
      const nickEl = document.getElementById("nickname");
      const spectateEl = document.getElementById("spectate");

      const btnCreate = document.getElementById("btnCreate");
      const btnJoin = document.getElementById("btnJoin");
      const btnStart = document.getElementById("btnStart");
      const btnLeave = document.getElementById("btnLeave");
      const btnNewGame = document.getElementById("btnNewGame");

      const holeCountEl = document.getElementById("holeCount");
      const ruleEl = document.getElementById("rule");
      const fastPickEl = document.getElementById("fastPick");
      const btnSetOpt = document.getElementById("btnSetOpt");

      const stageEl = document.getElementById("stage");
      const roundEl = document.getElementById("round");
      const boardEl = document.getElementById("board");
      const publicChipsEl = document.getElementById("publicChips");
      const playersEl = document.getElementById("players");
      const turnHintEl = document.getElementById("turnHint");

      const sheetBackdropEl = document.getElementById("sheetBackdrop");
      const sheetEl = document.getElementById("sheet");
      const sheetTitleEl = document.getElementById("sheetTitle");
      const sheetListEl = document.getElementById("sheetList");
      const btnCloseSheetEl = document.getElementById("btnCloseSheet");

      const modalBackdropEl = document.getElementById("modalBackdrop");
      const showdownModalEl = document.getElementById("showdownModal");
      const showdownSubEl = document.getElementById("showdownSub");
      const showdownListEl = document.getElementById("showdownList");
      const btnCloseModalEl = document.getElementById("btnCloseModal");

      let ws;
      let myPid = null;
      let state = null;
      let currentRid = null;
      let lastShowdownHandNo = null;
      let lastGameOver = null;

      // 断线重连：指数退避
      let reconnectTimer = null;
      let reconnectAttempt = 0;
      let manuallyClosed = false;

      const LS_PID = "theGang_pid";
      const LS_RID = "theGang_rid";
      const LS_NICK = "theGang_nickname";
      const LS_SPECTATE = "theGang_spectate";

      function parseCard(code) {
        const r = code?.[0] || "?";
        const s = code?.[1] || "?";
        const suitMap = { s: "♠", h: "♥", d: "♦", c: "♣" };
        const sym = suitMap[s] || s;
        const color = (s === "h" || s === "d") ? "red" : "black";
        return { r, s, sym, color };
      }

      function cardEl(code) {
        const c = parseCard(code);
        const d = document.createElement("div");
        d.className = `playingCard ${c.color}`;
        d.innerHTML = `
          <div class="corner"><span class="r">${c.r}</span><span class="s">${c.sym}</span></div>
          <div class="big">${c.sym}</div>
          <div class="corner" style="justify-content:flex-end;"><span class="s">${c.sym}</span><span class="r">${c.r}</span></div>
        `;
        return d;
      }

      function chipCircleEl(n, { clickable = false, small = false, title = "", round = null, marked = false, onClick = null } = {}) {
        const d = document.createElement("div");
        d.className = "chipCircle" + (clickable ? " clickable" : "") + (small ? " small" : "");
        if (round) d.classList.add("r" + String(round));
        if (marked) d.classList.add("marked");
        d.textContent = n;
        if (title) d.title = title;
        if (clickable && typeof onClick === "function") d.onclick = onClick;
        return d;
      }

      function logLocal(s) {
        const d = document.createElement("div");
        d.className = "logItem muted";
        d.textContent = s;
        logEl.appendChild(d);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function send(msg) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          logLocal("未连接服务器，发送失败：" + (msg?.type || "unknown"));
          return;
        }
        ws.send(JSON.stringify(msg));
      }

      function meInState() {
        return (state?.players || []).find(p => p.pid === myPid) || null;
      }

      function openSheet(title, rows) {
        // title 支持字符串或 {round, chip}
        sheetTitleEl.innerHTML = "";
        if (typeof title === "string") {
          sheetTitleEl.textContent = title;
        } else if (title && typeof title === "object" && title.round && title.chip) {
          const wrap = document.createElement("div");
          wrap.className = "row";
          wrap.style.gap = "10px";
          const t = document.createElement("div");
          t.textContent = `R${title.round}`;
          const icon = chipCircleEl(title.chip, { small: true, round: Number(title.round) });
          const tail = document.createElement("div");
          tail.textContent = "流转";
          wrap.appendChild(t);
          wrap.appendChild(icon);
          wrap.appendChild(tail);
          sheetTitleEl.appendChild(wrap);
        } else {
          sheetTitleEl.textContent = "流转";
        }
        sheetListEl.innerHTML = "";
        if (!rows.length) {
          const r = document.createElement("div");
          r.className = "sheetRow";
          r.textContent = "（暂无记录）";
          sheetListEl.appendChild(r);
        } else {
          for (const s of rows) {
            const r = document.createElement("div");
            r.className = "sheetRow";
            r.textContent = s;
            sheetListEl.appendChild(r);
          }
        }
        sheetBackdropEl.classList.add("show");
        sheetEl.classList.add("show");
      }

      function closeSheet() {
        sheetBackdropEl.classList.remove("show");
        sheetEl.classList.remove("show");
      }

      function openChipTrace(round, chip) {
        const logs = state?.logs || [];
        const events = logs
          .filter(e => (e.event === "chip_take" || e.event === "chip_steal") && Number(e.round) === Number(round) && Number(e.chip) === Number(chip))
          .sort((a,b) => Number(a.seq||0) - Number(b.seq||0));
        const rows = events.map(e => {
          if (e.event === "chip_take") {
            return `#${e.seq}  ${e.actor || e.actorPid} 从公共区拿取筹码 #${e.chip}`;
          }
          if (e.event === "chip_steal") {
            return `#${e.seq}  ${e.actor || e.actorPid} 夺取 ${e.fromPlayer || e.fromPid} 的筹码 #${e.chip}`;
          }
          return `#${e.seq}  ${e.text || ""}`;
        });
        openSheet({ round, chip }, rows);
      }

      function suitSym(s) {
        return ({ s: "♠", h: "♥", d: "♦", c: "♣" }[s] || s);
      }

      function prettyCardCode(code) {
        const r = code?.[0];
        const s = code?.[1];
        if (!r || !s) return code || "";
        return String(r).toUpperCase() + suitSym(String(s).toLowerCase());
      }

      function prettyText(t) {
        const s = String(t || "");
        return s.replace(/\b([2-9TJQKA])([shdc])\b/g, (_, r, su) => (String(r).toUpperCase() + suitSym(String(su).toLowerCase())));
      }

      function openShowdown() {
        const settings = state?.settings || {};
        const handNo = settings.handNo ?? null;
        if (!handNo) return;
        if (lastShowdownHandNo === handNo) return;
        lastShowdownHandNo = handNo;

        const players = (state?.players || []).slice();
        const n = players.length;
        const chipSorted = players.slice().sort((a,b) => {
          const ca = Number((a.chipsByRound||{})["4"] ?? (a.chipsByRound||{})[4] ?? 9999);
          const cb = Number((b.chipsByRound||{})["4"] ?? (b.chipsByRound||{})[4] ?? 9999);
          return ca - cb;
        });
        const bestRanking = (lastGameOver?.showdown?.ranking || []).slice(); // best first
        const handRankByPid = new Map(bestRanking.map((d, i) => [d.pid, i + 1]));

        showdownSubEl.textContent = `规则=${settings.rule || "-"}  手牌=${settings.holeCount || "-"}  房间=${state?.rid || "-"}`;
        showdownListEl.innerHTML = "";
        for (const p of chipSorted) {
          const r4 = (p.chipsByRound || {})["4"] ?? (p.chipsByRound || {})[4];
          const box = document.createElement("div");
          box.className = "rankRow";
          const top = document.createElement("div");
          top.className = "rankTop";
          const left = document.createElement("div");
          const hr = handRankByPid.get(p.pid);
          const needChip = (typeof hr === "number") ? (n - hr + 1) : null;
          left.innerHTML = `<div class="rankName">${p.nickname || p.pid}</div><div class="muted">牌力排名：${hr ? ("#" + hr + "/" + n) : "（未知）"}  ·  筹码R4：${r4 ?? "-"}` + (needChip ? `（应为 ${needChip}）` : "") + `</div>`;
          const right = document.createElement("div");
          const tag = document.createElement("div");
          tag.className = "pill";
          const desc = p.hand?.desc ? (" " + p.hand.desc) : "";
          tag.textContent = (p.hand?.categoryName || "（未知牌型）") + desc;
          right.appendChild(tag);
          top.appendChild(left);
          top.appendChild(right);
          box.appendChild(top);

          const holeRow = document.createElement("div");
          holeRow.className = "cards";
          for (const c of (p.hole || [])) holeRow.appendChild(cardEl(c));
          box.appendChild(holeRow);

          const sub = document.createElement("div");
          sub.className = "rankSub";
          sub.textContent = `最佳5张：${(p.hand?.five || []).map(prettyCardCode).join(" ")}`;
          box.appendChild(sub);

          showdownListEl.appendChild(box);
        }

        modalBackdropEl.classList.add("show");
        showdownModalEl.classList.add("show");
      }

      function closeModal() {
        modalBackdropEl.classList.remove("show");
        showdownModalEl.classList.remove("show");
      }

      function render() {
        if (!state) return;
        stageEl.textContent = state.stageName || state.stage;
        roundEl.textContent = state.round || "-";
        ridShowEl.textContent = state.rid || "-";
        currentRid = state.rid;
        if (currentRid) ridEl.value = currentRid;
        if (currentRid) localStorage.setItem(LS_RID, currentRid);

        const settings = state.settings || {};
        const me = meInState();
        const isHost = !!(me && me.isHost);
        const isDraftingStage = ["drafting", "preflop", "flop", "turn", "river"].includes(state.stage);
        const fastPick = !!settings.fastPick;
        const myInHand = !!(me && me.inHand);
        const myPickedThisRound = !!(me && me.chipsByRound && (me.chipsByRound[String(state.round)] || me.chipsByRound[state.round]));
        const canAct = isDraftingStage && myInHand && !myPickedThisRound;
        const isMyTurn = fastPick ? canAct : (canAct && state.currentTurnPid === myPid);

        // 按钮状态
        btnStart.disabled = !(isHost && !state.started && (state.players || []).filter(p => p.inHand).length >= 2);
        btnNewGame.disabled = !(isHost && state.stage === "showdown");
        btnLeave.disabled = !state?.rid;

        const canSetOpt = !!(isHost && (!state.started || state.stage === "showdown" || state.stage === "lobby"));
        btnSetOpt.disabled = !canSetOpt;
        holeCountEl.disabled = !canSetOpt;
        ruleEl.disabled = !canSetOpt;
        fastPickEl.disabled = !canSetOpt;
        if (settings.holeCount) holeCountEl.value = String(settings.holeCount);
        if (settings.rule) ruleEl.value = String(settings.rule);
        fastPickEl.checked = !!settings.fastPick;

        // 提示
        if (!isDraftingStage) {
          turnHintEl.textContent = (state.stage === "showdown")
            ? "亮牌阶段：已结算（自动公布手牌）"
            : (state.started ? "当前不在选筹码阶段" : "等待房主开始");
        } else {
          turnHintEl.textContent = fastPick
            ? (canAct ? "实时筹码：你可以直接拿取/夺取" : "实时筹码：你本轮已拿过筹码或未参与")
            : (state.currentTurnPid === myPid ? "轮到你：点击公共筹码拿取，或点他人筹码夺取" : "等待他人行动…");
        }

        // 公共牌
        boardEl.innerHTML = "";
        for (const c of state.board || []) boardEl.appendChild(cardEl(c));

        // 公共筹码
        publicChipsEl.innerHTML = "";
        for (const n of (state.publicChips || [])) {
          const c = chipCircleEl(n, {
            clickable: isMyTurn,
            round: state.round,
            title: isMyTurn ? "点击拿取" : "点击查看流转",
            onClick: isMyTurn
              ? () => send({ type: "pick_chip", chip: n, from: "public" })
              : () => openChipTrace(state.round, n),
          });
          // 即使不可拿，也允许点查看流转
          if (!isMyTurn) c.onclick = () => openChipTrace(state.round, n);
          publicChipsEl.appendChild(c);
        }

        // 玩家区
        playersEl.innerHTML = "";
        for (const p of (state.players || [])) {
          const card = document.createElement("div");
          card.className = "playerCard";
          const isMe = p.pid === myPid;
          const tags = [];
          if (p.isHost) tags.push("房主");
          if (p.spectator) tags.push("观战");
          else if (state.started && !p.inHand) tags.push("观战/未参与");
          else if (p.pending) tags.push("待加入");
          if (state.currentTurnPid === p.pid && isDraftingStage && !fastPick) tags.push("行动中");

          const top = document.createElement("div");
          top.className = "playerTop";
          const left = document.createElement("div");
          left.innerHTML = `<div class="playerName">${p.nickname || p.pid}${isMe ? "（你）" : ""}</div>`;
          const right = document.createElement("div");
          right.className = "tags";
          for (const t of tags) {
            const tag = document.createElement("div");
            tag.className = "pill";
            tag.textContent = t;
            right.appendChild(tag);
          }
          top.appendChild(left);
          top.appendChild(right);
          card.appendChild(top);

          // 房主踢人（仅未开始）
          if (isHost && !state.started && p.pid !== myPid && !p.isHost) {
            const kick = document.createElement("button");
            kick.className = "ghost";
            kick.style.height = "36px";
            kick.style.padding = "0 10px";
            kick.textContent = "踢";
            kick.onclick = () => {
              send({ type: "kick_player", targetPid: p.pid });
              logLocal("已发送：踢人 " + (p.nickname || p.pid));
            };
            right.appendChild(kick);
          }

          // 筹码（只显示“名字+筹码”为主；手牌仅在本人/观战/结算时显示）
          const chips = p.chipsByRound || {};
          const marks = p.chipMarksByRound || {};
          const curChip = chips[String(state.round)] ?? chips[state.round];
          const curMarked = !!(marks[String(state.round)] ?? marks[state.round]);

          const chipLine = document.createElement("div");
          chipLine.className = "chipLine";
          const leftChip = document.createElement("div");
          leftChip.className = "muted";
          leftChip.textContent = "本轮筹码";
          const rightChip = document.createElement("div");
          if (curChip) {
            const clickable = isMyTurn && !isMe && !p.spectator && p.inHand;
            const cc = chipCircleEl(curChip, {
              clickable,
              round: state.round,
              marked: curMarked,
              title: clickable ? "点击夺取 / 查看流转" : "点击查看流转",
              onClick: clickable
                ? () => send({ type: "pick_chip", chip: Number(curChip), from: "player", fromPid: p.pid })
                : () => openChipTrace(state.round, curChip),
            });
            if (!clickable) cc.onclick = () => openChipTrace(state.round, curChip);
            rightChip.appendChild(cc);
          } else {
            const t = document.createElement("div");
            t.className = "muted";
            t.textContent = "（未拿）";
            rightChip.appendChild(t);
          }
          chipLine.appendChild(leftChip);
          chipLine.appendChild(rightChip);
          card.appendChild(chipLine);

          // 历史筹码（精简）
          const rounds = Object.keys(chips).map(k => Number(k)).filter(n => Number.isFinite(n)).sort((a,b)=>a-b);
          const his = document.createElement("div");
          his.className = "chipHistory";
          for (const r of rounds) {
            const chipN = chips[String(r)] ?? chips[r];
            if (!chipN) continue;
            const marked = !!(marks[String(r)] ?? marks[r]);
            const cc = chipCircleEl(chipN, { small: true, round: r, marked, clickable: true, onClick: () => openChipTrace(r, chipN) });
            his.appendChild(cc);
          }
          if (his.childNodes.length) {
            const label = document.createElement("div");
            label.className = "muted";
            label.textContent = "历史筹码";
            card.appendChild(label);
            card.appendChild(his);
          }

          const showHoles = isMe || (me && me.spectator) || state.stage === "showdown";
          if (showHoles && (p.hole || []).length) {
            const label = document.createElement("div");
            label.className = "muted";
            label.textContent = "手牌";
            card.appendChild(label);
            const row = document.createElement("div");
            row.className = "cards";
            for (const c of (p.hole || [])) row.appendChild(cardEl(c));
            card.appendChild(row);
            if (p.hand?.categoryName) {
              const tag = document.createElement("div");
              tag.className = "pill ok";
              tag.textContent = p.hand.categoryName + (p.hand.desc ? (" " + p.hand.desc) : "");
              card.appendChild(tag);
            }
          }

          playersEl.appendChild(card);
        }

        // 日志（简单列表，最新在下）
        const logs = (state.logs || []).slice().sort((a,b)=>Number(a.seq||0)-Number(b.seq||0)).slice(-120);
        logEl.innerHTML = "";
        for (const e of logs) {
          const it = document.createElement("div");
          it.className = "logItem";
          const r = (e.round === 0 || e.round == null) ? "" : `R${e.round} `;
          it.textContent = `• ${r}${prettyText(e.text || "")}`;
          logEl.appendChild(it);
        }
        logEl.scrollTop = logEl.scrollHeight;

        // 结算自动弹窗
        if (state.stage === "showdown") openShowdown();
      }

      async function loadHistory() {
        try {
          historyEl.innerHTML = '<div class="muted">加载中…</div>';
          const qs = new URLSearchParams();
          qs.set("limit", "50");
          if (currentRid) qs.set("rid", currentRid);
          const res = await fetch("/api/history?" + qs.toString());
          const data = await res.json();
          const items = (data.items || []).slice().reverse();
          historyEl.innerHTML = "";
          if (!items.length) {
            historyEl.innerHTML = '<div class="muted">（暂无历史）</div>';
            return;
          }
          for (const rec of items) {
            const box = document.createElement("div");
            box.className = "sheetRow";
            const ok = rec?.result?.ok;
            const s = `${rec.iso || ""}  局#${rec.handNo ?? "-"}  ${ok ? "胜利" : "失败"}  规则=${rec?.settings?.rule || "-"}  手牌=${rec?.settings?.holeCount || "-"}`;
            box.textContent = prettyText(s);
            historyEl.appendChild(box);
          }
        } catch (e) {
          historyEl.innerHTML = '<div class="muted">加载失败</div>';
        }
      }

      function connect() {
        const params = new URLSearchParams(location.search);
        const paramWs = (params.get("ws") || "").trim();
        let wsUrl = paramWs || (localStorage.getItem("WS_URL") || "");
        if (paramWs) localStorage.setItem("WS_URL", paramWs);

        if (wsUrl) {
          if (wsUrl.startsWith("https://")) wsUrl = "wss://" + wsUrl.slice("https://".length);
          if (wsUrl.startsWith("http://")) wsUrl = "ws://" + wsUrl.slice("http://".length);
        } else {
          const proto = location.protocol === "https:" ? "wss" : "ws";
          wsUrl = `${proto}://${location.host}/ws`;
        }

        let finalWsUrl = wsUrl;
        try {
          const u = new URL(wsUrl, location.href);
          const savedRid = (localStorage.getItem(LS_RID) || "").trim();
          const savedPid = (localStorage.getItem(LS_PID) || "").trim();
          if (savedRid) u.searchParams.set("rid", savedRid);
          if (savedPid) u.searchParams.set("pid", savedPid);
          finalWsUrl = u.toString();
        } catch (e) {}

        ws = new WebSocket(finalWsUrl);
        logLocal("WS 连接：" + wsUrl);

        ws.onopen = () => {
          logLocal("已连接服务器");
          reconnectAttempt = 0;
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }

          const savedPid = (localStorage.getItem(LS_PID) || "").trim();
          const savedRid = (localStorage.getItem(LS_RID) || "").trim();
          const savedNick = (localStorage.getItem(LS_NICK) || "").trim();
          const savedSpectate = (localStorage.getItem(LS_SPECTATE) || "") === "1";
          if (!savedPid && savedRid && savedNick) {
            send({ type: "join_room", rid: savedRid, nickname: savedNick, spectate: savedSpectate });
            logLocal("自动加入房间：" + savedRid + (savedSpectate ? "（观战）" : ""));
          }
        };
        ws.onclose = () => {
          logLocal("连接断开，尝试重连中…");
          if (manuallyClosed) return;
          scheduleReconnect();
        };
        ws.onerror = () => logLocal("连接错误");
        ws.onmessage = (ev) => {
          const msg = JSON.parse(ev.data);
          if (msg.type === "hello") {
            myPid = msg.pid;
            pidEl.textContent = myPid;
            if (myPid) localStorage.setItem(LS_PID, myPid);
            logLocal("分配 pid: " + myPid);
          } else if (msg.type === "room_state") {
            if (msg.forPid && myPid && msg.forPid !== myPid) return;
            state = msg.state;
            render();
          } else if (msg.type === "left_room") {
            state = null;
            ridShowEl.textContent = "-";
            btnLeave.disabled = true;
            btnNewGame.disabled = true;
            stageEl.textContent = "-";
            roundEl.textContent = "-";
            boardEl.innerHTML = "";
            publicChipsEl.innerHTML = "";
            playersEl.innerHTML = "";
            logEl.innerHTML = "";
            localStorage.removeItem(LS_RID);
            logLocal("已退出房间");
          } else if (msg.type === "error") {
            logLocal("错误：" + msg.message);
          } else if (msg.type === "game_over") {
            lastGameOver = msg.result || null;
            logLocal(msg.result?.ok ? "游戏结束：胜利" : "游戏结束：失败");
            // 立即打开结算
            openShowdown();
          } else {
            logLocal("未知消息：" + ev.data);
          }
        };
      }

      function scheduleReconnect() {
        if (reconnectTimer) return;
        const base = 500;
        const max = 8000;
        const delay = Math.min(max, base * Math.pow(2, reconnectAttempt));
        reconnectAttempt += 1;
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          connect();
        }, delay);
      }

      btnCreate.onclick = () => {
        const nickname = nickEl.value.trim();
        if (!nickname) return logLocal("请输入昵称");
        localStorage.setItem(LS_NICK, nickname);
        localStorage.setItem(LS_SPECTATE, "0");
        spectateEl.checked = false;
        send({ type: "create_room", nickname });
        logLocal("已发送：创建房间");
      };
      btnJoin.onclick = () => {
        const nickname = nickEl.value.trim();
        const rid = ridEl.value.trim();
        if (!nickname || !rid) return logLocal("请输入昵称与房间号");
        const spectate = !!spectateEl.checked;
        localStorage.setItem(LS_NICK, nickname);
        localStorage.setItem(LS_RID, rid);
        localStorage.setItem(LS_SPECTATE, spectate ? "1" : "0");
        send({ type: "join_room", rid, nickname, spectate });
        logLocal("已发送：加入房间 " + rid + (spectate ? "（观战）" : ""));
      };
      btnStart.onclick = () => { send({ type: "start_game" }); logLocal("已发送：开始"); };
      btnNewGame.onclick = () => { send({ type: "new_game" }); logLocal("已发送：下一局"); };
      btnLeave.onclick = () => {
        send({ type: "leave_room" });
        localStorage.removeItem(LS_RID);
        logLocal("已发送：退出");
      };
      btnSetOpt.onclick = () => {
        const holeCount = Number(holeCountEl.value || 2);
        const rule = String(ruleEl.value || "holdem");
        const fastPick = !!fastPickEl.checked;
        send({ type: "set_options", holeCount, rule, fastPick });
        logLocal(`已发送：设置（手牌${holeCount}张，${rule}，实时筹码=${fastPick ? "开" : "关"}）`);
      };

      btnCloseSheetEl.onclick = closeSheet;
      sheetBackdropEl.onclick = closeSheet;
      btnCloseModalEl.onclick = closeModal;
      modalBackdropEl.onclick = closeModal;

      try {
        const savedNick = (localStorage.getItem(LS_NICK) || "").trim();
        const savedRid = (localStorage.getItem(LS_RID) || "").trim();
        const savedSpectate = (localStorage.getItem(LS_SPECTATE) || "") === "1";
        if (savedNick && !nickEl.value) nickEl.value = savedNick;
        if (savedRid && !ridEl.value) ridEl.value = savedRid;
        spectateEl.checked = savedSpectate;
      } catch (e) {}

      historyDetailsEl.addEventListener("toggle", () => {
        if (historyDetailsEl.open) loadHistory();
      });

      connect();
    </script>
  </body>
</html>

