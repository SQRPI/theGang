<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>纸牌帮</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; background:#f6f7fb; color:#111; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      .grid { display:grid; grid-template-columns: 360px 1fr; gap: 14px; align-items:start; }
      .card { background:white; border:1px solid #e6e8f0; border-radius: 12px; padding: 14px; box-shadow: 0 4px 18px rgba(20,20,40,.06); }
      h1 { font-size: 18px; margin: 0 0 10px; }
      h2 { font-size: 14px; margin: 0 0 10px; color:#2c2c35; }
      .row { display:flex; gap: 8px; align-items:center; }
      input, button, select { height: 36px; border-radius: 10px; border:1px solid #d7d9e3; padding: 0 10px; background:white; }
      button { cursor:pointer; background:#111827; color:white; border-color:#111827; }
      button.secondary { background:white; color:#111827; }
      button:disabled { opacity:.5; cursor:not-allowed; }
      .muted { color:#6b7280; font-size: 12px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .chips { display:flex; flex-wrap:wrap; gap: 10px; }
      .chip { border:1px solid #d7d9e3; padding: 8px 10px; border-radius:999px; background:#fff; }
      .chipCircle {
        width: 44px; height: 44px; border-radius: 999px;
        display:flex; align-items:center; justify-content:center;
        border: 2px solid #cfd3e3;
        background: radial-gradient(circle at 30% 30%, #ffffff, #eef1ff);
        box-shadow: 0 8px 18px rgba(10, 15, 40, .10);
        font-weight: 800;
        user-select:none;
      }
      /* 不同轮次的筹码配色（R1~R4） */
      .chipCircle.r1 { border-color: #fb7185; background: radial-gradient(circle at 30% 30%, #ffffff, #ffe4e6); }
      .chipCircle.r2 { border-color: #60a5fa; background: radial-gradient(circle at 30% 30%, #ffffff, #dbeafe); }
      .chipCircle.r3 { border-color: #34d399; background: radial-gradient(circle at 30% 30%, #ffffff, #d1fae5); }
      .chipCircle.r4 { border-color: #a78bfa; background: radial-gradient(circle at 30% 30%, #ffffff, #ede9fe); }
      .chipCircle.clickable { cursor:pointer; border-color:#111827; }
      .chipCircle.clickable:hover { transform: translateY(-1px); }
      .chipCircle.small { width: 30px; height: 30px; font-size: 12px; font-weight: 800; box-shadow:none; }
      .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border:1px solid #e6e8f0; background:#fbfbff; }
      .players { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
      .p { border:1px solid #eceef6; border-radius: 12px; padding: 10px; background:#fcfdff; }
      .p .name { font-weight:600; display:flex; justify-content:space-between; }
      .p .chips { margin-top: 8px; }
      .board { display:flex; gap: 8px; flex-wrap:wrap; }
      .pcards { display:flex; gap: 10px; flex-wrap:wrap; }
      .playingCard {
        width: 54px; height: 76px;
        border-radius: 12px;
        border: 1px solid #d7d9e3;
        background: linear-gradient(180deg, #ffffff, #fbfbff);
        box-shadow: 0 10px 25px rgba(10, 15, 40, .10);
        padding: 8px;
        display:flex; flex-direction:column; justify-content:space-between;
      }
      .playingCard .r { font-weight: 900; font-size: 16px; }
      .playingCard .s { font-size: 16px; }
      .playingCard.red { color: #b91c1c; }
      .playingCard.black { color: #111827; }
      .playingCard .corner { display:flex; gap: 6px; align-items:center; }
      .playingCard .big { font-size: 28px; line-height: 1; text-align:center; opacity: .9; }
      .chipHistory { display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }
      .chipBadge { display:flex; align-items:center; gap:6px; border:1px dashed #d7d9e3; padding: 6px 10px; border-radius: 12px; background:#fff; }
      .chipBadge .lbl { font-size: 11px; color:#6b7280; }
      .logPanel { background:#0b1020; color:#d6e0ff; border-radius: 12px; padding: 10px; height: 260px; overflow:auto; }
      .logGroup { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(214,224,255,.12); }
      .logGroup:last-child { border-bottom:none; padding-bottom:0; margin-bottom:0; }
      .logGroupTitle { font-size: 12px; color:#9db1ff; margin-bottom: 6px; display:flex; gap:8px; align-items:center; }
      .logItem { font-size: 12px; line-height: 1.5; color:#d6e0ff; opacity:.96; }
      .logItem.muted { color:#9aa6c9; }
      .ok { color: #0f766e; font-weight:600; }
      .bad { color: #b91c1c; font-weight:600; }

      /* ----------------------------
         响应式：手机小屏适配
         - 小屏时改为单列，让“连接与房间”在最上面
         ---------------------------- */
      @media (max-width: 900px) {
        .wrap { padding: 12px; }
        .grid { grid-template-columns: 1fr; }
        /* 确保左侧“连接与房间”卡片在上面 */
        .grid > .card:first-child { order: 0; }
        .grid > .card:last-child { order: 1; }

        .row { flex-wrap: wrap; }
        input, button, select { width: 100%; }
        .logPanel { height: 220px; }
      }

      @media (max-width: 520px) {
        .players { grid-template-columns: 1fr; }
        .grid { gap: 10px; }
        .card { padding: 12px; }
        .playingCard { width: 50px; height: 72px; }
        .chipCircle { width: 40px; height: 40px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h2>连接与房间</h2>
          <div class="row" style="margin-bottom:8px;">
            <input id="nickname" placeholder="昵称（必填）" style="flex:1;" maxlength="20" />
          </div>
          <div class="row" style="margin-bottom:8px;">
            <button id="btnCreate">创建房间</button>
            <input id="rid" placeholder="房间号" class="mono" style="flex:1;" />
          </div>
          <div class="row" style="margin-bottom:8px;">
            <button id="btnJoin" class="secondary">加入房间</button>
            <button id="btnStart" disabled>房主开始</button>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <button id="btnLeave" class="secondary" disabled>退出房间</button>
            <button id="btnNewGame" disabled>下一局</button>
          </div>
          <div class="muted">
            你的 pid：<span class="mono" id="pid">-</span><br />
            当前房间：<span class="mono" id="ridShow">-</span>
          </div>
          <hr style="border:none;border-top:1px solid #eceef6;margin:14px 0;" />
          <h2>行动</h2>
          <div class="muted" id="turnHint">未开始</div>
          <div style="height:8px;"></div>
          <div class="muted">
            轮到你时：直接点击右侧的公共筹码拿取，或点击其他玩家的“本轮筹码”进行夺取。
          </div>
        </div>

        <div class="card">
          <h2>游戏状态</h2>
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <div class="pill">阶段：<span id="stage">-</span></div>
            <div class="pill">第 <span id="round">-</span> 轮</div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="muted">公共牌</div>
            <div class="pcards" id="board"></div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="muted">当前轮公共筹码（可被拿取）</div>
            <div class="chips" id="publicChips"></div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="muted">玩家（点击他人的“本轮筹码”可夺取）</div>
            <div class="players" id="players"></div>
          </div>

          <div class="muted">日志（含每轮筹码流转）</div>
          <div class="logPanel" id="log"></div>
        </div>
      </div>
    </div>

    <script>
      const logEl = document.getElementById("log");
      const pidEl = document.getElementById("pid");
      const ridEl = document.getElementById("rid");
      const ridShowEl = document.getElementById("ridShow");
      const nickEl = document.getElementById("nickname");
      const btnCreate = document.getElementById("btnCreate");
      const btnJoin = document.getElementById("btnJoin");
      const btnStart = document.getElementById("btnStart");
      const btnLeave = document.getElementById("btnLeave");
      const btnNewGame = document.getElementById("btnNewGame");
      const stageEl = document.getElementById("stage");
      const roundEl = document.getElementById("round");
      const boardEl = document.getElementById("board");
      const publicChipsEl = document.getElementById("publicChips");
      const playersEl = document.getElementById("players");
      const turnHintEl = document.getElementById("turnHint");

      let ws;
      let myPid = null;
      let state = null;
      let currentRid = null;
      let lastLogSeq = 0;

      // 断线重连：指数退避
      let reconnectTimer = null;
      let reconnectAttempt = 0;
      let manuallyClosed = false;

      const LS_PID = "theGang_pid";
      const LS_RID = "theGang_rid";
      const LS_NICK = "theGang_nickname";
      const stageNameMap = {
        lobby: "等待中",
        drafting: "翻牌前",
        preflop: "翻牌前",
        flop: "翻牌",
        turn: "转牌",
        river: "河牌",
        showdown: "亮牌",
      };
      const stageOrder = ["lobby", "preflop", "flop", "turn", "river", "showdown"];

      function parseCard(code) {
        const r = code?.[0] || "?";
        const s = code?.[1] || "?";
        const suitMap = { s: "♠", h: "♥", d: "♦", c: "♣" };
        const sym = suitMap[s] || s;
        const color = (s === "h" || s === "d") ? "red" : "black";
        return { r, s, sym, color };
      }

      function cardEl(code) {
        const c = parseCard(code);
        const d = document.createElement("div");
        d.className = `playingCard ${c.color}`;
        d.innerHTML = `
          <div class="corner"><span class="r">${c.r}</span><span class="s">${c.sym}</span></div>
          <div class="big">${c.sym}</div>
          <div class="corner" style="justify-content:flex-end;"><span class="s">${c.sym}</span><span class="r">${c.r}</span></div>
        `;
        return d;
      }

      function chipCircleEl(n, { clickable = false, small = false, title = "", round = null } = {}) {
        const d = document.createElement("div");
        d.className = "chipCircle" + (clickable ? " clickable" : "") + (small ? " small" : "");
        if (round) d.classList.add("r" + String(round));
        d.textContent = n;
        if (title) d.title = title;
        return d;
      }

      function addLogLine(s) {
        // 兼容：连接/错误等本地提示也用日志面板展示
        const d = document.createElement("div");
        d.className = "logItem muted";
        d.textContent = s;
        logEl.appendChild(d);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function send(msg) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addLogLine("未连接服务器，发送失败：" + (msg?.type || "unknown"));
          return;
        }
        ws.send(JSON.stringify(msg));
      }

      function render() {
        if (!state) return;
        stageEl.textContent = state.stageName || state.stage;
        roundEl.textContent = state.round || "-";
        ridShowEl.textContent = state.rid || "-";
        currentRid = state.rid;
        if (currentRid) ridEl.value = currentRid;
        if (currentRid) localStorage.setItem(LS_RID, currentRid);

        const isDraftingStage = ["drafting", "preflop", "flop", "turn", "river"].includes(state.stage);
        const isMyTurn = state.currentTurnPid === myPid && isDraftingStage;

        boardEl.innerHTML = "";
        for (const c of state.board || []) {
          boardEl.appendChild(cardEl(c));
        }

        publicChipsEl.innerHTML = "";
        for (const n of state.publicChips || []) {
          const wrap = document.createElement("div");
          wrap.className = "chip";
          const c = chipCircleEl(n, { clickable: isMyTurn, title: "点击从公共区拿取", round: state.round });
          if (isMyTurn) {
            c.onclick = () => {
              send({ type: "pick_chip", chip: n, from: "public" });
            };
          }
          wrap.appendChild(c);
          publicChipsEl.appendChild(wrap);
        }

        playersEl.innerHTML = "";
        for (const p of state.players || []) {
          const d = document.createElement("div");
          d.className = "p";
          const isMe = p.pid === myPid;
          const isTurn = state.currentTurnPid === p.pid;
          const holeCodes = (p.hole || []);
          const chips = p.chipsByRound || {};
          const chipRounds = Object.keys(chips).sort((a,b)=>Number(a)-Number(b));
          const currentRoundChip = chips[String(state.round)];
          d.innerHTML = `
            <div class="name">
              <span>${p.nickname} ${p.isHost ? "（房主）" : ""} ${isMe ? "（你）" : ""}</span>
              <span class="${isTurn ? "ok" : "muted"}">${isTurn ? "行动中" : ""}</span>
            </div>
            <div class="muted mono" style="margin-top:6px;">pid: ${p.pid}</div>
            <div class="muted" style="margin-top:6px;">底牌（仅本人可见）</div>
            <div class="pcards" data-hole="1" style="margin-top:6px;"></div>
            <div class="muted" style="margin-top:6px;">历史筹码</div>
            <div class="chipHistory" data-his="1" style="margin-top:6px;"></div>
            <div class="row" style="margin-top:8px; justify-content:space-between;">
              <div class="muted">本轮筹码</div>
              <div class="row" style="gap:8px;" data-cur-chip="1"></div>
            </div>
          `;
          const hisWrap = d.querySelector('[data-his="1"]');
          if (chipRounds.length) {
            for (const r of chipRounds) {
              const badge = document.createElement("div");
              badge.className = "chipBadge";
              const lbl = document.createElement("div");
              lbl.className = "lbl";
              lbl.textContent = "R" + r;
              const chipN = chips[r];
              const cc = chipCircleEl(chipN, { small: true, round: Number(r) });
              badge.appendChild(lbl);
              badge.appendChild(cc);
              hisWrap.appendChild(badge);
            }
          } else {
            const tip = document.createElement("div");
            tip.className = "muted";
            tip.textContent = "（暂无）";
            hisWrap.appendChild(tip);
          }

          const holeWrap = d.querySelector('[data-hole="1"]');
          if (holeCodes.length) {
            for (const c of holeCodes) holeWrap.appendChild(cardEl(c));
          } else {
            const tip = document.createElement("div");
            tip.className = "muted";
            tip.textContent = isMe ? "（未发牌/未开始）" : "（不可见）";
            holeWrap.appendChild(tip);
          }

          const curChipWrap = d.querySelector('[data-cur-chip="1"]');
          if (currentRoundChip) {
            const c = chipCircleEl(currentRoundChip, { clickable: isMyTurn && !isMe, title: "点击夺取该玩家本轮筹码", round: state.round });
            if (isMyTurn && !isMe) {
              c.onclick = () => {
                send({ type: "pick_chip", chip: Number(currentRoundChip), from: "player", fromPid: p.pid });
              };
            }
            curChipWrap.appendChild(c);
          } else {
            const tip = document.createElement("div");
            tip.className = "muted";
            tip.textContent = "（未拿）";
            curChipWrap.appendChild(tip);
          }

          playersEl.appendChild(d);
        }

        const me = (state.players || []).find(p => p.pid === myPid);
        const canStart = me && me.isHost && !state.started;
        btnStart.disabled = !canStart;

        turnHintEl.textContent = !isDraftingStage
          ? (state.stage === "showdown"
              ? "亮牌阶段：牌局已结束，房主可点击「下一局」开始新一局"
              : (state.started ? "未在选筹码阶段" : "等待房主开始游戏"))
          : (isMyTurn ? "轮到你行动：直接点击公共筹码或点击其他玩家的本轮筹码" : `等待他人行动（当前：${state.currentTurnPid}）`);

        // 房间按钮状态
        btnLeave.disabled = !state?.rid;
        btnNewGame.disabled = !(me && me.isHost && state.stage === "showdown");

        // 结构化日志：每次全量重绘（最多 200 条，开销可接受），按阶段展示（翻牌前/翻牌/转牌/河牌/亮牌）
        const logs = state.logs || [];
        const grouped = new Map(); // key: stageId
        for (const e of logs) {
          // 新版服务端会附带 stage/stageName；旧日志则尝试用 round 推断
          let stageId = e.stage;
          if (!stageId) {
            const r = Number(e.round);
            stageId = (r === 1) ? "preflop"
              : (r === 2) ? "flop"
              : (r === 3) ? "turn"
              : (r === 4) ? "river"
              : "lobby";
          }
          if (!grouped.has(stageId)) grouped.set(stageId, []);
          grouped.get(stageId).push(e);
        }
        const keys = Array.from(grouped.keys()).sort((a, b) => {
          const ia = stageOrder.indexOf(a);
          const ib = stageOrder.indexOf(b);
          return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
        });
        logEl.innerHTML = "";
        for (const k of keys) {
          const g = document.createElement("div");
          g.className = "logGroup";
          const t = document.createElement("div");
          t.className = "logGroupTitle";
          const stageName = stageNameMap[k] || k;
          t.textContent = (k === "lobby") ? "房间/系统" : stageName;
          g.appendChild(t);
          const items = grouped.get(k) || [];
          items.sort((a, b) => Number(a.seq || 0) - Number(b.seq || 0));
          for (const e of items) {
            const it = document.createElement("div");
            it.className = "logItem";
            const r = (e.round === 0 || e.round === "-" || e.round == null) ? "" : (`R${e.round} `);
            it.textContent = "• " + r + (e.text || "");
            g.appendChild(it);
          }
          logEl.appendChild(g);
        }
        logEl.scrollTop = logEl.scrollHeight;
      }

      function connect() {
        // 支持通过 URL 参数指定后端 WS 地址，避免每次重新部署前端
        // 用法： https://xxx.vercel.app/?ws=wss://your-domain/ws
        // 也支持传 https://... 会自动转换成 wss://...
        const params = new URLSearchParams(location.search);
        const paramWs = (params.get("ws") || "").trim();
        let wsUrl = paramWs || (localStorage.getItem("WS_URL") || "");
        if (paramWs) localStorage.setItem("WS_URL", paramWs);

        if (wsUrl) {
          if (wsUrl.startsWith("https://")) wsUrl = "wss://" + wsUrl.slice("https://".length);
          if (wsUrl.startsWith("http://")) wsUrl = "ws://" + wsUrl.slice("http://".length);
        } else {
          const proto = location.protocol === "https:" ? "wss" : "ws";
          wsUrl = `${proto}://${location.host}/ws`;
        }

        // 尝试断线重连/刷新恢复：在 ws url 上带 rid + pid
        let finalWsUrl = wsUrl;
        try {
          const u = new URL(wsUrl, location.href);
          const savedRid = (localStorage.getItem(LS_RID) || "").trim();
          const savedPid = (localStorage.getItem(LS_PID) || "").trim();
          if (savedRid) u.searchParams.set("rid", savedRid);
          if (savedPid) u.searchParams.set("pid", savedPid);
          finalWsUrl = u.toString();
        } catch (e) {
          // URL 解析失败就退回原样
        }

        ws = new WebSocket(finalWsUrl);
        addLogLine("WS 连接：" + wsUrl);

        ws.onopen = () => {
          addLogLine("已连接服务器");
          reconnectAttempt = 0;
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }

          // 若没有 pid（无法 resume），但有 rid + nickname，则尝试自动加入（仅适用于尚未开始的房间）
          const savedPid = (localStorage.getItem(LS_PID) || "").trim();
          const savedRid = (localStorage.getItem(LS_RID) || "").trim();
          const savedNick = (localStorage.getItem(LS_NICK) || "").trim();
          if (!savedPid && savedRid && savedNick) {
            send({ type: "join_room", rid: savedRid, nickname: savedNick });
            addLogLine("自动加入房间：" + savedRid);
          }
        };
        ws.onclose = () => {
          addLogLine("连接断开，尝试重连中…");
          if (manuallyClosed) return;
          scheduleReconnect();
        };
        ws.onerror = () => addLogLine("连接错误");
        ws.onmessage = (ev) => {
          const msg = JSON.parse(ev.data);
          if (msg.type === "hello") {
            myPid = msg.pid;
            pidEl.textContent = myPid;
            if (myPid) localStorage.setItem(LS_PID, myPid);
            addLogLine("分配 pid: " + myPid);
          } else if (msg.type === "room_state") {
            state = msg.state;
            render();
          } else if (msg.type === "error") {
            addLogLine("错误：" + msg.message);
          } else if (msg.type === "game_over") {
            // 结束信息由服务端日志也会写入，这里只做轻提示
            if (msg.result?.ok) addLogLine("游戏结束：胜利");
            else addLogLine("游戏结束：失败");
          } else {
            addLogLine("未知消息：" + ev.data);
          }
        };
      }

      function scheduleReconnect() {
        if (reconnectTimer) return;
        const base = 500; // ms
        const max = 8000; // ms
        const delay = Math.min(max, base * Math.pow(2, reconnectAttempt));
        reconnectAttempt += 1;
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          connect();
        }, delay);
      }

      btnCreate.onclick = () => {
        const nickname = nickEl.value.trim();
        if (!nickname) return addLogLine("请输入昵称");
        localStorage.setItem(LS_NICK, nickname);
        send({ type: "create_room", nickname });
        addLogLine("已发送：创建房间");
      };
      btnJoin.onclick = () => {
        const nickname = nickEl.value.trim();
        const rid = ridEl.value.trim();
        if (!nickname || !rid) return addLogLine("请输入昵称与房间号");
        localStorage.setItem(LS_NICK, nickname);
        localStorage.setItem(LS_RID, rid);
        send({ type: "join_room", rid, nickname });
        addLogLine("已发送：加入房间 " + rid);
      };
      btnStart.onclick = () => {
        send({ type: "start_game" });
        addLogLine("已发送：开始游戏");
      };
      btnLeave.onclick = () => {
        send({ type: "leave_room" });
        state = null;
        ridShowEl.textContent = "-";
        btnLeave.disabled = true;
        btnNewGame.disabled = true;
        stageEl.textContent = "-";
        roundEl.textContent = "-";
        boardEl.innerHTML = "";
        publicChipsEl.innerHTML = "";
        playersEl.innerHTML = "";
        logEl.innerHTML = "";
        addLogLine("已发送：退出房间");
        localStorage.removeItem(LS_RID);
      };
      btnNewGame.onclick = () => {
        send({ type: "new_game" });
        addLogLine("已发送：下一局");
      };

      // 刷新后自动填充上次昵称/房间号
      try {
        const savedNick = (localStorage.getItem(LS_NICK) || "").trim();
        const savedRid = (localStorage.getItem(LS_RID) || "").trim();
        if (savedNick && !nickEl.value) nickEl.value = savedNick;
        if (savedRid && !ridEl.value) ridEl.value = savedRid;
      } catch (e) {}

      connect();
    </script>
  </body>
</html>

